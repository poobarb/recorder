#!/bin/sh
# postinstall for Raspbian Buster 10
#
# Create owntracks user & group
# binaries are setuid to owntracks
# storage belongs to owntracks:owntracks

set -e

case "$1" in
    configure)
        getent group owntracks > /dev/null || /usr/sbin/groupadd --system owntracks
        getent passwd owntracks > /dev/null || adduser --system --disabled-password --disabled-login --ingroup owntracks --no-create-home owntracks
        mkdir -p /var/spool/owntracks/recorder/store/last
        mkdir -p /var/spool/owntracks/recorder/store/ghash
        chown -R owntracks:owntracks /var/spool/owntracks/recorder/store
	chown owntracks:owntracks /etc/default/ot-recorder
	chown -R owntracks:owntracks /var/spool/owntracks/
        chown owntracks:owntracks /usr/bin/ocat /usr/sbin/ot-recorder

	chmod a+rX -R /usr/share/owntracks/

        chmod 4111 /usr/bin/ocat /usr/sbin/ot-recorder
        /usr/sbin/ot-recorder --initialize


	if [ -x /bin/systemctl ]; then
		install -m644 /usr/share/doc/ot-recorder/ot-recorder.service /etc/systemd/system/ot-recorder.service
		systemctl --system daemon-reload || exit 0 # catch failure in docker setup
	fi
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
